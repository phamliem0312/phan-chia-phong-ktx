<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống phân chia phòng ký túc xá</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        .upload-area.dragover {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
        .file-info {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .btn-group-custom {
            gap: 10px;
        }
        .status-message {
            margin-top: 15px;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">
                    <i class="fas fa-building"></i>
                    Hệ thống phân chia phòng ký túc xá
                </h1>
            </div>
        </div>

        <!-- Card Upload File Mới -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-upload"></i>
                            Upload File Dữ Liệu Mới
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Lưu ý:</strong> Upload file mới sẽ ghi đè lên file hiện tại trong thư mục uploads
                        </div>
                        
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="upload-area" id="uploadAreaPhong">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                        <h6>Danh sách phòng mới</h6>
                                        <p class="text-muted">Kéo thả file hoặc click để chọn</p>
                                        <input type="file" name="danhSachPhong" id="danhSachPhong" 
                                               accept=".xlsx,.xls" style="display: none;">
                                        <div id="fileInfoPhong" class="file-info d-none"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="upload-area" id="uploadAreaSinhVien">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                        <h6>Danh sách sinh viên mới</h6>
                                        <p class="text-muted">Kéo thả file hoặc click để chọn</p>
                                        <input type="file" name="danhSachSinhVien" id="danhSachSinhVien" 
                                               accept=".xlsx,.xls" style="display: none;">
                                        <div id="fileInfoSinhVien" class="file-info d-none"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center mt-3">
                                <button type="submit" class="btn btn-warning btn-lg" id="btnUpload">
                                    <i class="fas fa-upload"></i>
                                    Upload và Cập Nhật Files
                                </button>
                            </div>
                        </form>
                        
                        <div id="uploadStatus" class="status-message"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card Thông tin File Template -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle"></i>
                            Thông tin File Template
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="templateInfo" class="row">
                            <div class="col-md-6">
                                <div class="card border-primary">
                                    <div class="card-body text-center">
                                        <i class="fas fa-building fa-2x text-primary mb-2"></i>
                                        <h6>Danh sách phòng</h6>
                                        <div id="phongFileInfo">
                                            <span class="text-muted">Đang kiểm tra...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-success">
                                    <div class="card-body text-center">
                                        <i class="fas fa-users fa-2x text-success mb-2"></i>
                                        <h6>Danh sách sinh viên</h6>
                                        <div id="sinhVienFileInfo">
                                            <span class="text-muted">Đang kiểm tra...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <button id="btnRefreshInfo" class="btn btn-outline-secondary">
                                <i class="fas fa-sync"></i>
                                Làm mới thông tin
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card Tải Template và Xử lý -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-download"></i>
                            Tải File Template
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Tải file template để chỉnh sửa dữ liệu</p>
                        
                        <h6 class="text-primary">
                            <i class="fas fa-folder"></i>
                            Từ thư mục Templates (File mẫu gốc)
                        </h6>
                        <div class="d-grid gap-2 mb-3">
                            <a href="/template/phong" class="btn btn-outline-primary">
                                <i class="fas fa-file-excel"></i>
                                Tải mẫu danh sách phòng
                            </a>
                            <a href="/template/sinh-vien" class="btn btn-outline-primary">
                                <i class="fas fa-file-excel"></i>
                                Tải mẫu danh sách sinh viên
                            </a>
                        </div>
                        
                        <hr>
                        
                        <h6 class="text-success">
                            <i class="fas fa-folder-open"></i>
                            Từ thư mục Uploads (File đang sử dụng)
                        </h6>
                        <div class="d-grid gap-2">
                            <a href="/download/template-phong" class="btn btn-outline-success">
                                <i class="fas fa-file-excel"></i>
                                Tải file phòng hiện tại
                            </a>
                            <a href="/download/template-sinh-vien" class="btn btn-outline-success">
                                <i class="fas fa-file-excel"></i>
                                Tải file sinh viên hiện tại
                            </a>
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <small>
                                <i class="fas fa-info-circle"></i>
                                <strong>Hướng dẫn:</strong> Tải file mẫu từ Templates, chỉnh sửa dữ liệu, 
                                sau đó copy vào thư mục uploads để sử dụng.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cogs"></i>
                            Xử lý dữ liệu
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Sử dụng dữ liệu từ file template trong thư mục uploads</p>
                        <div class="d-grid gap-2">
                            <button id="btnPhanChia" class="btn btn-success btn-lg">
                                <i class="fas fa-play"></i>
                                Thực hiện phân chia phòng
                            </button>
                            <a href="/download/result" class="btn btn-outline-success" id="btnDownloadResult" 
                               style="display: none;">
                                <i class="fas fa-download"></i>
                                Tải kết quả phân chia
                            </a>
                        </div>
                        
                        <div id="processStatus" class="status-message"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card Kết quả -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar"></i>
                            Kết quả phân chia
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="resultArea" class="text-center text-muted">
                            <i class="fas fa-info-circle fa-2x mb-3"></i>
                            <p>Kết quả sẽ hiển thị sau khi thực hiện phân chia phòng</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Xử lý upload và kiểm tra file template
        document.addEventListener('DOMContentLoaded', function() {
            const uploadForm = document.getElementById('uploadForm');
            const btnPhanChia = document.getElementById('btnPhanChia');
            const btnDownloadResult = document.getElementById('btnDownloadResult');
            const btnRefreshInfo = document.getElementById('btnRefreshInfo');
            const btnUpload = document.getElementById('btnUpload');
            
            // Setup drag and drop cho upload areas
            setupDragAndDrop('uploadAreaPhong', 'danhSachPhong', 'fileInfoPhong');
            setupDragAndDrop('uploadAreaSinhVien', 'danhSachSinhVien', 'fileInfoSinhVien');
            
            // Kiểm tra file template khi load trang
            checkTemplateFiles();
            
            function setupDragAndDrop(areaId, inputId, infoId) {
                const uploadArea = document.getElementById(areaId);
                const fileInput = document.getElementById(inputId);
                const fileInfo = document.getElementById(infoId);
                
                uploadArea.addEventListener('click', () => fileInput.click());
                
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        fileInput.files = files;
                        showFileInfo(files[0], fileInfo);
                    }
                });
                
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        showFileInfo(e.target.files[0], fileInfo);
                    }
                });
            }
            
            function showFileInfo(file, infoElement) {
                infoElement.innerHTML = `
                    <i class="fas fa-file-excel text-success"></i>
                    <strong>${file.name}</strong> (${(file.size / 1024 / 1024).toFixed(2)} MB)
                `;
                infoElement.classList.remove('d-none');
            }
            
            // Xử lý submit upload form
            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(uploadForm);
                const uploadStatus = document.getElementById('uploadStatus');
                
                // Kiểm tra xem có file nào được chọn không
                const hasPhongFile = document.getElementById('danhSachPhong').files.length > 0;
                const hasSinhVienFile = document.getElementById('danhSachSinhVien').files.length > 0;
                
                if (!hasPhongFile && !hasSinhVienFile) {
                    uploadStatus.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Vui lòng chọn ít nhất một file để upload</div>';
                    return;
                }
                
                try {
                    btnUpload.disabled = true;
                    uploadStatus.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Đang upload...</div>';
                    
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        uploadStatus.innerHTML = `<div class="alert alert-success"><i class="fas fa-check"></i> ${result.message}</div>`;
                        
                        // Reset form
                        uploadForm.reset();
                        document.getElementById('fileInfoPhong').classList.add('d-none');
                        document.getElementById('fileInfoSinhVien').classList.add('d-none');
                        
                        // Làm mới thông tin file template
                        setTimeout(() => {
                            checkTemplateFiles();
                        }, 1000);
                        
                    } else {
                        uploadStatus.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times"></i> ${result.message}</div>`;
                    }
                } catch (error) {
                    uploadStatus.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times"></i> Lỗi: ${error.message}</div>`;
                } finally {
                    btnUpload.disabled = false;
                }
            });

            async function checkTemplateFiles() {
                try {
                    const response = await fetch('/api/check-templates');
                    const result = await response.json();
                    
                    if (result.success) {
                        updateFileInfo(result.data);
                    } else {
                        console.error('Lỗi kiểm tra template:', result.message);
                    }
                } catch (error) {
                    console.error('Lỗi:', error);
                }
            }
            
            function updateFileInfo(data) {
                const phongFileInfo = document.getElementById('phongFileInfo');
                const sinhVienFileInfo = document.getElementById('sinhVienFileInfo');
                
                // Cập nhật thông tin file phòng
                if (data.phongFile.exists) {
                    if (data.phongFile.error) {
                        phongFileInfo.innerHTML = `
                            <span class="text-danger">
                                <i class="fas fa-exclamation-triangle"></i>
                                ${data.phongFile.error}
                            </span>
                        `;
                    } else {
                        phongFileInfo.innerHTML = `
                            <span class="text-success">
                                <i class="fas fa-check"></i>
                                File tồn tại
                            </span><br>
                            <small class="text-muted">${data.phongFile.count} phòng</small>
                        `;
                    }
                } else {
                    phongFileInfo.innerHTML = `
                        <span class="text-warning">
                            <i class="fas fa-times"></i>
                            File không tồn tại
                        </span>
                    `;
                }
                
                // Cập nhật thông tin file sinh viên
                if (data.sinhVienFile.exists) {
                    if (data.sinhVienFile.error) {
                        sinhVienFileInfo.innerHTML = `
                            <span class="text-danger">
                                <i class="fas fa-exclamation-triangle"></i>
                                ${data.sinhVienFile.error}
                            </span>
                        `;
                    } else {
                        sinhVienFileInfo.innerHTML = `
                            <span class="text-success">
                                <i class="fas fa-check"></i>
                                File tồn tại
                            </span><br>
                            <small class="text-muted">${data.sinhVienFile.count} sinh viên</small>
                        `;
                    }
                } else {
                    sinhVienFileInfo.innerHTML = `
                        <span class="text-warning">
                            <i class="fas fa-times"></i>
                            File không tồn tại
                        </span>
                    `;
                }
                
                // Kích hoạt/vô hiệu hóa nút phân chia
                btnPhanChia.disabled = !(data.phongFile.exists && data.sinhVienFile.exists && 
                                       !data.phongFile.error && !data.sinhVienFile.error);
            }
            
            // Xử lý làm mới thông tin
            btnRefreshInfo.addEventListener('click', checkTemplateFiles);
            
            // Xử lý phân chia phòng
            btnPhanChia.addEventListener('click', async () => {
                const processStatus = document.getElementById('processStatus');
                const resultArea = document.getElementById('resultArea');
                
                try {
                    processStatus.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Đang xử lý phân chia phòng...</div>';
                    
                    const response = await fetch('/api/phan-chia-phong', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        processStatus.innerHTML = `<div class="alert alert-success"><i class="fas fa-check"></i> ${result.message}</div>`;
                        
                        // Hiển thị kết quả
                        const thongKe = result.data.thongKe;
                        resultArea.innerHTML = `
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <div class="card bg-primary text-white">
                                        <div class="card-body">
                                            <h3>${thongKe.tongSinhVien}</h3>
                                            <p>Tổng sinh viên</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-success text-white">
                                        <div class="card-body">
                                            <h3>${thongKe.sinhVienDaPhanPhong}</h3>
                                            <p>Đã phân phòng</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-warning text-white">
                                        <div class="card-body">
                                            <h3>${thongKe.sinhVienChuaPhanPhong}</h3>
                                            <p>Chưa phân phòng</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        btnDownloadResult.style.display = 'block';
                    } else {
                        processStatus.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times"></i> ${result.message}</div>`;
                    }
                } catch (error) {
                    processStatus.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times"></i> Lỗi: ${error.message}</div>`;
                }
            });
        });
    </script>
</body>
</html>
